rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Get user document data
     */
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    /**
     * Check if user has role in specified tenant (multi-tenant support)
     */
    function hasRole(tenantId, allowedRoles) {
      let userData = getUserData();
      return tenantId in userData.tenantMemberships
        && userData.tenantMemberships[tenantId].role in allowedRoles
        && userData.tenantMemberships[tenantId].isActive == true;
    }

    /**
     * Get user's tenant ID from their profile (legacy support)
     */
    function getUserTenant() {
      return getUserData().tenantId;
    }

    /**
     * Get user's role from their profile (legacy support)
     */
    function getUserRole() {
      return getUserData().role;
    }

    /**
     * Check if user belongs to specified tenant (supports both legacy and new structure)
     */
    function belongsToTenant(tenantId) {
      return isAuthenticated() && (
        (getUserData().keys().hasAny(['tenantMemberships']) &&
         tenantId in getUserData().tenantMemberships &&
         getUserData().tenantMemberships[tenantId].isActive == true) ||
        getUserData().tenantId == tenantId
      );
    }

    /**
     * Check if user is admin (legacy support)
     */
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    /**
     * Check if user is staff or admin (legacy support)
     */
    function isStaffOrAdmin() {
      return isAuthenticated() && getUserRole() in ['staff', 'admin'];
    }

    /**
     * Check if user is admin of the specified tenant (multi-tenant aware)
     */
    function isTenantAdmin(tenantId) {
      return isAuthenticated() && (
        hasRole(tenantId, ['admin']) ||
        (belongsToTenant(tenantId) && isAdmin()) // Legacy fallback
      );
    }

    /**
     * Check if user is admin or staff of the specified tenant
     */
    function isAdminOrStaff(tenantId) {
      return isAuthenticated() && (
        hasRole(tenantId, ['admin', 'staff']) ||
        (belongsToTenant(tenantId) && isStaffOrAdmin()) // Legacy fallback
      );
    }

    /**
     * Check if user is a super admin (platform-level access)
     * Super admins can manage all tenants, view all data, and perform system administration
     */
    function isSuperAdmin() {
      return isAuthenticated() &&
             getUserData().keys().hasAny(['role']) &&
             getUserData().role == 'super-admin';
    }

    // ============================================================================
    // USER PROFILES
    // ============================================================================

    /**
     * Users can read/update their own profile
     * Super admins can read all user profiles for tenant management
     */
    match /users/{userId} {
      // Read: User can read their own profile, or super admin can read any profile
      allow read: if (isAuthenticated() && request.auth.uid == userId) || isSuperAdmin();

      // Create: User can create their own profile during signup
      // Cloud Functions can create users (bypasses security rules with Admin SDK)
      allow create: if isAuthenticated() &&
                       request.auth.uid == userId &&
                       request.resource.data.keys().hasAny(['tenantId', 'tenantMemberships']);

      // Update: User can update their own profile (except tenantMemberships and role)
      //         Super admins can update any user (for role changes)
      //         Cloud Functions handle tenantMemberships updates
      allow update: if (isAuthenticated() &&
                       request.auth.uid == userId &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['tenantMemberships', 'createdAt', 'role'])) ||
                       isSuperAdmin();

      // Delete: Only Cloud Functions can delete users (admin SDK)
      allow delete: if false;
    }

    // ============================================================================
    // INVITATIONS
    // ============================================================================

    /**
     * Invitation collection - managed primarily by Cloud Functions
     */
    match /invitations/{invitationId} {
      // Admins can read invitations for their tenant
      // Supports both legacy (tenantId + role) and new (tenantMemberships) structures
      allow read: if isAuthenticated() && (
                     hasRole(resource.data.tenantId, ['admin']) ||
                     (belongsToTenant(resource.data.tenantId) && isAdmin())
                   );

      // Only Cloud Functions can create invitations (via callable function)
      // Client-side code calls the createInvitation Cloud Function
      allow create: if false;

      // Only Cloud Functions can update invitations
      allow update: if false;

      // No one can delete invitations (audit trail)
      allow delete: if false;
    }

    // ============================================================================
    // TENANT METADATA
    // ============================================================================

    /**
     * Tenant metadata: read by anyone (needed for initial app load and subdomain availability check)
     * Write by tenant admin or super admin
     * Public signup: Anyone can create a new tenant with pending-approval status
     */
    match /tenantMetadata/{tenantId} {
      allow read: if true; // Public read - needed before authentication and subdomain check

      // Allow public creation of new tenants with pending-approval status
      allow create: if request.resource.data.tenantStatus.status == 'pending-approval'
                    && request.resource.data.keys().hasAll(['businessName', 'subdomain', 'contactEmail'])
                    && request.resource.data.subdomain is string
                    && request.resource.data.subdomain.size() >= 3;

      // Allow updates by tenant admin or super admin
      allow update: if isTenantAdmin(tenantId) || isSuperAdmin();

      // No delete unless super admin
      allow delete: if isSuperAdmin();
    }

    // ============================================================================
    // SUPER ADMIN DATA
    // ============================================================================

    /**
     * Super admin data collection - platform-level configuration and analytics
     * Only accessible by super admins
     */
    match /superAdminData/{docId} {
      allow read, write: if isSuperAdmin();
    }

    /**
     * Tenant requests collection - new tenant signup requests
     * Super admins can read/approve, anyone can create (for signup form)
     */
    match /tenantRequests/{requestId} {
      // Anyone can create a tenant request (signup form)
      allow create: if request.resource.data.keys().hasAll(['businessName', 'subdomain', 'contactEmail', 'status'])
                    && request.resource.data.status == 'pending';

      // Super admins can read and update (approve/reject)
      allow read, update: if isSuperAdmin();

      // No one can delete requests (audit trail)
      allow delete: if false;
    }

    // ============================================================================
    // TENANT-SCOPED DATA
    // ============================================================================

    match /tenants/{tenantId} {

      // Base rule: Authenticated users can read tenant they belong to
      // Super admins can read all tenant data for monitoring
      allow read: if belongsToTenant(tenantId) || isSuperAdmin();

      // -------------------------
      // SETTINGS
      // -------------------------
      match /settings/{settingId} {
        // PUBLIC READ: Landing page must be accessible to non-authenticated users
        allow read: if true;
        allow write: if isTenantAdmin(tenantId);
      }

      // -------------------------
      // PRODUCTS
      // -------------------------
      match /products/{productId} {
        allow read: if belongsToTenant(tenantId);
        allow write: if isTenantAdmin(tenantId) ||
                        hasRole(tenantId, ['admin', 'staff']);
      }

      // -------------------------
      // CATEGORIES
      // -------------------------
      match /categories/{categoryId} {
        allow read: if belongsToTenant(tenantId);
        allow write: if isTenantAdmin(tenantId) ||
                        hasRole(tenantId, ['admin', 'staff']);
      }

      // -------------------------
      // ORDERS
      // -------------------------
      match /orders/{orderId} {
        allow read: if belongsToTenant(tenantId) ||
                       (request.auth != null && resource.data.userId == request.auth.uid);

        // Customers can create orders for their tenant
        // UPDATED: Also allow anonymous users (guests) to create orders
        allow create: if request.auth != null &&
                         request.resource.data.tenantId == tenantId &&
                         request.resource.data.userId == request.auth.uid &&
                         (belongsToTenant(tenantId) || request.auth.token.firebase.sign_in_provider == 'anonymous');

        // Staff and admins can update order status
        allow update: if belongsToTenant(tenantId) &&
                         hasRole(tenantId, ['admin', 'staff']);

        // Only admins can delete orders
        allow delete: if isTenantAdmin(tenantId);
      }

      // -------------------------
      // TABLES (Phase 2)
      // -------------------------
      match /tables/{tableId} {
        allow read: if belongsToTenant(tenantId);
        allow write: if isTenantAdmin(tenantId) ||
                        hasRole(tenantId, ['admin', 'staff']);
      }

      // -------------------------
      // RESERVATIONS (Customer Flow Redesign - Phase 3)
      // -------------------------
      match /reservations/{reservationId} {
        // PUBLIC CREATE: Anyone can create a reservation (guest checkout)
        // Validation ensures required fields are present
        allow create: if request.resource.data.tenantId == tenantId
                      && request.resource.data.status == 'pending'
                      && request.resource.data.date is string
                      && request.resource.data.time is string
                      && request.resource.data.partySize is int
                      && request.resource.data.partySize >= 1
                      && request.resource.data.partySize <= 20
                      && request.resource.data.contactName is string
                      && request.resource.data.contactPhone is string
                      && request.resource.data.contactEmail is string;

        // READ: Admin/staff can read all reservations for their tenant
        allow read: if isAdminOrStaff(tenantId);

        // UPDATE: Admin/staff can update reservation status and notes
        // Tenant ID cannot be changed
        allow update: if isAdminOrStaff(tenantId)
                      && request.resource.data.tenantId == resource.data.tenantId;

        // DELETE: Only admin can delete reservations
        allow delete: if isTenantAdmin(tenantId);
      }

      // -------------------------
      // PAYMENTS (Phase 4)
      // -------------------------
      match /payments/{paymentId} {
        allow read: if belongsToTenant(tenantId);
        allow create: if belongsToTenant(tenantId);
        allow update: if isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
      }

      // -------------------------
      // CATCH-ALL (for future collections)
      // -------------------------
      match /{document=**} {
        allow read: if belongsToTenant(tenantId);
        allow write: if isTenantAdmin(tenantId);
      }
    }

    // ============================================================================
    // DENY ALL OTHER ACCESS
    // ============================================================================

    // Explicitly deny access to any collection not matched above
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
